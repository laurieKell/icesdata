---
title: "ICES Stocks - Indicators"
author: "L Kell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ICES Stocks - Indicators}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
bibliography: refs.bib
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  eval = TRUE,
  cache = TRUE,
  cache.path = "cache/indicators-",
  fig.path = "figures/indicators-",
  fig.width = 8,
  fig.height = 6,
  dev = "png"
)

iFig <- 0
iTab <- 0
```

```{r, libraries}
library(icesdata)
library(FLCore)
library(FLBRP)
library(FLife)
library(plyr)
library(ggplot2)
library(scales)

# Set default theme for all plots
theme_set(theme_ices(base_size = 12))

if (requireNamespace("GGally", quietly = TRUE)) {
  library(GGally)
}
if (requireNamespace("ggcorrplot", quietly = TRUE)) {
  library(ggcorrplot)
}
if (requireNamespace("ggplotFL", quietly = TRUE)) {
  library(ggplotFL)
}
if (requireNamespace("ss3om", quietly = TRUE)) {
  library(ss3om)
}
if (requireNamespace("r4ss", quietly = TRUE)) {
  library(r4ss)
}
if (requireNamespace("FLCandy", quietly = TRUE)) {
  library(FLCandy)
}
```

## Introduction

Progress towards ecosystem-based management (EBM) has been slow despite multiple governments committing to its implementation. Technical challenges and the uncertainty of complex models are often cited as reasons for the slow integration of ecosystem information into management decisions.

Understanding the structure of marine food webs and how they, as well as the services they support, respond when perturbed is a fundamental prerequisite of EBM. This understanding can help to identify trade-offs and assess the risks of ocean uses as well as the risks of failing to respond to pressures such as climate change.

**Note:** This vignette requires external data files and SS3 outputs. Some sections may not run without additional setup.

```{r, source, eval=FALSE}
# External source files needed for indicators
# source("C:/active/FLCandy/R/indicatorsBiol.R")
# source("C:/active/jabba-z/source/jabba-utils.R")
# source("C:/active/FLCandy/R/abi.R")
```

```{r, data-load}
# Load ICES data using standard data() function
data(icesdata)
data(info)
data(spp)
data(lw)

# Set up vignette data directory for saving outputs
vignetteDataDir = system.file("data/vignette-outputs", package = "icesdata")
if (!dir.exists(vignetteDataDir) || vignetteDataDir == "") {
  vignetteDataDir = file.path("data", "vignette-outputs")
  if (!dir.exists(vignetteDataDir)) {
    dir.create(vignetteDataDir, recursive = TRUE)
  }
}

# SS3 directory - will fail if not present
ss3Dir = file.path("data", "raw", "ss3")

# Stock list
stocks <- c("ank.27.78abd", "bss.27.4bc7ad-h", "bss.27.8ab",
            "cod 27a", "cod.27.24-32", "her.27.3031", "hke.27.3a46-8abd",
            "hke.27.8c9a", "hom.27.2a4a5b6a7a-ce-k8", "mon.27.8c9a",
            "pil.27.8abd", "pil.27.8c9a", "pra.27.3a4a")
```

```{r, ss3-data, eval=FALSE}
# SS3 data loading - requires r4ss and ss3om packages
# if (!is.null(ss3Dir) && requireNamespace("r4ss", quietly = TRUE) && 
#     requireNamespace("ss3om", quietly = TRUE)) {
#   ss1 <- plyr::mlply(data.frame(.id = stocks), function(.id) {
#     try(r4ss::SS_output(file.path(ss3Dir, .id), covar = FALSE))
#   })
#   names(ss1) <- stocks
#   
#   ss2 <- plyr::mlply(data.frame(.id = stocks), function(.id) {
#     try(ss3om::readFLSss3(file.path(ss3Dir, .id)))
#   })
#   names(ss2) <- stocks
#   
#   ss3 <- plyr::llply(ss1, function(.id) {
#     try(ss3om::buildFLSss330(.id))
#   })
#   
#   sr <- plyr::mlply(data.frame(.id = stocks), function(.id) {
#     try(ss3om::readFLSRss3(file.path(ss3Dir, .id)))
#   })
#   names(sr) <- stocks
#   
#   ss3 <- FLStocks(ss3[!plyr::laply(ss3, function(.id) "try-error" %in% class(.id))])
#   
#   if (!is.null(formas_data_dir)) {
#     save(ss1, ss2, ss3, file = file.path(formas_data_dir, "ss3", "ss.RData"))
#   }
# }
```

**Figure `r iFig <- iFig + 1; iFig`** Indicators analysis

